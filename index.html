<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AVD OT Calculator – Stable + Calendar (Auto-Fetch, v4.4)</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }

    * { box-sizing:border-box; }
    html, body { height:100%; }

    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin:0 auto;
      padding:18px;
    }

    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 22px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
      margin-bottom:16px;
    }

    h1 {
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }

    h2 {
      margin:16px 0 8px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .version {
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .muted { color:var(--muted); font-size:14px; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      text-decoration:none;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, color .12s ease,
                  transform .06s ease, box-shadow .12s ease;
    }
    .pill:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      transform:translateY(-0.5px);
      box-shadow:0 3px 8px rgba(15,23,42,0.35);
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }

    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }

    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input, select, textarea, button {
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      box-sizing:border-box;
    }

    input, select, textarea {
      width:100%;
    }
    textarea { resize:vertical; min-height:70px; }

    input::placeholder, textarea::placeholder { color:var(--muted); }

    .small-note,
    .note {
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .btn-row, .btnrow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    button {
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }

    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }

    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .danger {
      border-color:var(--danger) !important;
      color:var(--danger);
    }

    /* KPI cards */
    .kpi {
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top:12px;
    }
    .kpi > div {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
    }
    .big { font-size:20px; font-weight:700; }

    /* Log / table */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:10px;
    }
    th, td {
      border:1px solid var(--border);
      padding:6px 8px;
      vertical-align:top;
      text-align:left;
    }
    th {
      background:rgba(15,23,42,0.6);
      font-weight:600;
    }
    @media (prefers-color-scheme: light) {
      th { background:#e5e7eb; }
    }

    .logbox {
      border:2px dashed var(--border);
      border-radius:10px;
      padding:10px;
      background:var(--panel);
    }

    .badge {
      display:inline-block;
      font-size:12px;
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:999px;
      color:var(--muted);
    }

    /* Debug & API & Calendar settings panels */
    details.debug,
    details.api,
    details.calendar-settings,
    details.calendar-range,
    details.calendar-day-select {
      margin-top:10px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:8px 10px;
      background:rgba(15,23,42,0.4);
      font-size:11px;
    }
    @media (prefers-color-scheme: light) {
      details.debug,
      details.api,
      details.calendar-settings,
      details.calendar-range,
      details.calendar-day-select { background:#f3f4f6; }
    }

    details.calendar-range {
      display:none; /* HIDDEN as you requested */
    }

    details.debug summary,
    details.api summary,
    details.calendar-settings summary,
    details.calendar-range summary,
    details.calendar-day-select summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }

    details.debug pre {
      white-space:pre-wrap;
      font-size:11px;
      margin-top:4px;
    }

    .danger-text { color:var(--danger); }

    .flag-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      font-size:12px;
    }
    .flag-row label {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      margin-bottom:0;
    }
    .flag-row input[type="checkbox"] {
      width:auto;
      accent-color:var(--accent);
    }

    .day-type-label {
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>


<body>
  <div class="wrap">
    <div class="card">
      <!-- Header with version + pill -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            AVD Overtime Calculator
            <span class="version">v4.4</span>
          </h1>
          <div class="muted">
            Daily calculator: leave defaults to <strong>07:45</strong> (adjustable below).
            Time before <strong>09:00</strong> and after <strong>17:00</strong> counts as overtime,
            with a <strong>15 minute</strong> deduction each side on field days.
            Full office/admin and office-finish days can be flagged to adjust overtime.
          </div>
        </div>
        <a href="https://frazerboorman.github.io/" class="pill">Frazer · AVD TOOLS</a>
      </div>

      <!-- STEP 1 – Calendar -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar</div>
        <div class="grid">
          <div style="align-self:end;">
            <div class="btnrow">
              <button id="signin" class="primary" type="button">Sign in to Google</button>
              <button id="fetchEvents" type="button">Load last 7 days (incl. today)</button>
            </div>
            <div id="authStatus" class="note">Status: Not signed in</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label for="eventPick">Recent events (newest first)</label>
            <select id="eventPick">
              <option value="">— Select recent event (optional) —</option>
            </select>
          </div>
          <div style="align-self:end;">
            <button id="useSel" type="button">Use selection</button>
            <div class="note">Picking an event auto-fills the Date and Job fields.</div>
          </div>
        </div>

        <!-- Advanced calendar date range — now hidden -->
        <details class="calendar-range">
          <summary>Advanced: calendar date range (defaults to last 7 days including today)</summary>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label for="fromDate">From</label>
              <input id="fromDate" type="date" />
            </div>
            <div>
              <label for="toDate">To</label>
              <input id="toDate" type="date" />
            </div>
          </div>
        </details>
      </div>

      <!-- STEP 2 – Daily inputs -->
      <div class="section">
        <div class="section-title">Step 2 – Daily inputs</div>
        <div class="grid">
          <div>
            <label for="jobRef">Job / Location</label>
            <input id="jobRef" placeholder="e.g. The Minster – Axminster – EX13 5AQ" />
          </div>
          <div>
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="leaveTime">Time left</label>
            <input id="leaveTime" type="time" step="300" />
            <div class="note">Defaults to 07:45 if left blank.</div>
          </div>
          <div>
            <label for="returnTime">Time returned</label>
            <input id="returnTime" type="time" step="300" />
          </div>
          <div>
            <label for="baseRate">Base hourly rate (£)</label>
            <input id="baseRate" inputmode="decimal" value="15.70" />
          </div>
        </div>

        <div class="flag-row">
          <label>
            <input type="checkbox" id="fullOfficeDay" />
            Full office/admin day (no overtime)
          </label>
          <label>
            <input type="checkbox" id="officeFinishDay" />
            Returned to office by ~16:00 (no overtime after 17:00)
          </label>
        </div>

        <div class="btnrow">
          <button id="calcBtn" class="primary" type="button">Calculate</button>
          <button id="addRowBtn" type="button">Add results to table</button>
        </div>
      </div>

      <!-- STEP 3 – Results -->
      <div class="section">
        <div class="section-title">Step 3 – Results</div>
        <div class="kpi">
          <div>
            <div class="muted">Total worked (raw)</div>
            <div class="big" id="allHours">—</div>
          </div>
          <div>
            <div class="muted">Pre-09:00 OT (after 15m deduction)</div>
            <div class="big" id="graceHours">—</div>
          </div>
          <div>
            <div class="muted">Core hours</div>
            <div class="big" id="coreHours">—</div>
          </div>
          <div>
            <div class="muted">Post-17:00 OT (after 15m deduction)</div>
            <div class="big" id="otHours">—</div>
          </div>
          <div>
            <div class="muted">OT Due @ base rate</div>
            <div class="big" id="otBase">—</div>
          </div>
        </div>
        <div id="dayTypeLabel" class="day-type-label">Day type: —</div>
      </div>

      <!-- STEP 4 – Log & export -->
      <div class="section">
        <div class="section-title">Step 4 – Log & export</div>
        <h2 id="logHeader">LOG <span id="logCount" class="badge">0 entries</span></h2>

        <div id="logBox" class="logbox">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width:120px;">Actions</th>
                <th>Date</th>
                <th>Job / Location</th>
                <th>Time left</th>
                <th>Time returned</th>
                <th>Total worked</th>
                <th>Total overtime</th>
                <th>OT Due</th>
              </tr>
            </thead>

            <tbody id="logBody">
              <tr id="placeholderRow">
                <td colspan="8" class="note">No entries yet — add one above.</td>
              </tr>
            </tbody>
          </table>

          <div class="btnrow">
            <button id="exportDoc" class="primary" type="button">Export Word (.docx)</button>
            <button id="exportPdf" type="button">Export PDF</button>
            <button id="clearLog" class="danger" type="button">Clear table</button>
          </div>
        </div>

        <p class="note" style="margin-top:12px;">
          Authorisation signature appears on exported documents only.
        </p>
      </div>
    </div>

    <!-- Global debug panel -->
    <details class="debug">
      <summary>Debug panel</summary>
      <pre id="debugLog">(empty)</pre>
    </details>

    <!-- Calendar settings -->
    <details class="calendar-settings">
      <summary>Calendar settings (Calendar ID)</summary>
      <div class="small-note">Normally leave this unchanged.</div>
      <div style="max-width:460px;margin-top:6px;">
        <label for="calendarId">Calendar ID</label>
        <input id="calendarId"
               value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
      </div>
    </details>

    <!-- API KEY PANEL -->
    <details class="api">
      <summary>API key (OpenAI)</summary>
      <div class="small-note" style="margin-top:4px;">
        Stored locally in <code>localStorage['avd_job_report_openai_key']</code>.
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
        <input id="apiKeyInput" type="password" placeholder="sk-…" style="flex:1 1 220px;max-width:380px;" />
        <button type="button" id="saveApiKeyBtn">Save</button>
        <button type="button" id="clearApiKeyBtn">Forget</button>
      </div>
      <div id="apiKeyStatus" class="small-note"></div>
    </details>
  </div>

<script>
/* ---------- CONSTANTS ---------- */
const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

let accessToken = null;
let tokenClient = null;

const STORAGE_KEY = "avd_ot_stable_calendar_autofetch_v4_4";
const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";

const GRACE_END = 9*60;
const CORE_END = 17*60;

/* ---------- DEBUG ---------- */
function logDebug(msg) {
  const el = document.getElementById("debugLog");
  if (!el) return;
  const ts = new Date().toISOString().replace("T"," ").slice(0,19);
  el.textContent += `[${ts}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
}

function setStatus(msg, ok) {
  const el = document.getElementById("authStatus");
  if (!el) return;
  el.textContent = "Status: " + msg;
  el.className = "note";
  logDebug("AUTH: " + msg);
}

/* ---------- CALENDAR AUTH ---------- */
function initAuth() {
  if (!window.google?.accounts?.oauth2) {
    logDebug("Google auth library not ready.");
    return;
  }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    prompt: "",
    callback: (resp) => {
      if (resp?.access_token) {
        accessToken = resp.access_token;
        setStatus("Signed in", true);
        fetchEvents();
      } else {
        setStatus("Sign-in failed", false);
      }
    }
  });
}

function signIn() {
  if (!tokenClient) initAuth();
  if (!tokenClient) return setStatus("Auth not ready", false);
  tokenClient.requestAccessToken();
}

function timeRangeISO(d) {
  const [y,m,dd] = d.split("-").map(Number);
  const start = new Date(Date.UTC(y,m-1,dd,0,0,0));
  const end   = new Date(Date.UTC(y,m-1,dd,23,59,59));
  return { timeMin:start.toISOString(), timeMax:end.toISOString() };
}

function spanISO(from,to) {
  return {
    timeMin: timeRangeISO(from).timeMin,
    timeMax: timeRangeISO(to).timeMax
  };
}

async function fetchEvents() {
  if (!accessToken) return setStatus("Sign in first", false);

  const calId = document.getElementById("calendarId").value.trim();

  const now = new Date();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(),23,59,59);
  const start = new Date(end);
  start.setDate(start.getDate()-6);
  start.setHours(0,0,0,0);

  const fmt = d => d.toISOString().slice(0,10);
  const fromStr = fmt(start);
  const toStr   = fmt(end);

  document.getElementById("fromDate").value = fromStr;
  document.getElementById("toDate").value   = toStr;

  const {timeMin,timeMax} = spanISO(fromStr,toStr);

  const url = new URL("https://www.googleapis.com/calendar/v3/calendars/" +
    encodeURIComponent(calId) + "/events");
  url.searchParams.set("singleEvents","true");
  url.searchParams.set("orderBy","startTime");
  url.searchParams.set("timeMin",timeMin);
  url.searchParams.set("timeMax",timeMax);
  url.searchParams.set("maxResults","2500");

  logDebug("fetch: "+url);

  const res = await fetch(url,{headers:{Authorization:"Bearer "+accessToken}});
  if (!res.ok) return setStatus("API error "+res.status, false);
  const data = await res.json();

  const sel = document.getElementById("eventPick");
  sel.innerHTML = '<option value="">— Select recent event (optional) —</option>';

  const items = (data.items||[]).slice().sort((a,b)=>{
    const aa = a.start?.dateTime || a.start?.date;
    const bb = b.start?.dateTime || b.start?.date;
    return new Date(bb) - new Date(aa);
  });

  items.forEach(ev=>{
    const title = ev.summary || "(no title)";
    const date = ev.start.date || ev.start.dateTime?.slice(0,10) || "";
    const opt = document.createElement("option");
    opt.value = title;
    opt.textContent = `${title} — ${date}`;
    opt.dataset.date = date;
    sel.appendChild(opt);
  });

  setStatus("Loaded "+items.length+" events", true);
}

/* ---------- DATE FORMAT CONVERSION ---------- */
function toDMY(iso) {
  if (!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}-${m}-${y}`;
}

/* ---------- CALCULATION ---------- */
function minutesFromHHMM(v) {
  if (!v) return null;
  const [hh,mm] = v.split(":").map(Number);
  return hh*60 + mm;
}

function fmtHours(mins) {
  if (mins==null || isNaN(mins)) return "—";
  const h = Math.floor(mins/60);
  const m = mins%60;
  return `${h}h ${String(m).padStart(2,"0")}m`;
}

function fmtMoney(p) {
  if (p==null || isNaN(p)) return "—";
  return "£"+p.toFixed(2);
}

function updateDayTypeLabel(full,finish) {
  const el = document.getElementById("dayTypeLabel");
  if (!full && !finish) el.textContent = "Day type: Field day";
  else if (full) el.textContent = "Day type: Full office/admin day";
  else el.textContent = "Day type: Office-finish day";
}

function calc() {
  const leaveVal = document.getElementById("leaveTime").value || "07:45";
  let leaveMin = minutesFromHHMM(leaveVal);
  const rtVal = document.getElementById("returnTime").value;
  let endMin  = minutesFromHHMM(rtVal);

  if (endMin < leaveMin) endMin += 1440;

  const full = document.getElementById("fullOfficeDay").checked;
  const finish = !full && document.getElementById("officeFinishDay").checked;

  let effectiveEnd = endMin;
  if (finish) effectiveEnd = Math.min(endMin, CORE_END);

  const totalWorked = Math.max(0, effectiveEnd - leaveMin);

  let rawPre9=0, rawPost17=0, rawCore=0;

  if (leaveMin < GRACE_END)
    rawPre9 = Math.max(0, Math.min(effectiveEnd,GRACE_END) - leaveMin);

  if (effectiveEnd > GRACE_END) {
    rawCore = Math.max(0,
      Math.min(effectiveEnd,CORE_END) - Math.max(leaveMin,GRACE_END)
    );
  }

  if (!finish && effectiveEnd > CORE_END)
    rawPost17 = Math.max(0, effectiveEnd - CORE_END);

  let pre9OT  = rawPre9;
  let post17OT = rawPost17;

  if (full) {
    pre9OT = 0;
    post17OT = 0;
  } else if (finish) {
    pre9OT = Math.max(0, rawPre9 - 15);
    post17OT = 0;
  } else {
    if (pre9OT>0) pre9OT = Math.max(0, pre9OT-15);
    if (post17OT>0) post17OT = Math.max(0, post17OT-15);
  }

  const baseRate = parseFloat(document.getElementById("baseRate").value.replace(",",".")) || 0;
  const otDue = ((pre9OT+post17OT)/60)*baseRate;

  document.getElementById("allHours").textContent = fmtHours(totalWorked);
  document.getElementById("graceHours").textContent = fmtHours(pre9OT);
  document.getElementById("coreHours").textContent  = fmtHours(rawCore);
  document.getElementById("otHours").textContent    = fmtHours(post17OT);
  document.getElementById("otBase").textContent     = fmtMoney(otDue);

  updateDayTypeLabel(full,finish);

  return {
    totalWorked,
    rawTotalOT: rawPre9 + rawPost17,
    otDue
  };
}

/* ---------- LOG HANDLING ---------- */
function updateLogCount() {
  const rows = [...document.querySelectorAll("#logBody tr")].filter(r=>!r.id);
  document.getElementById("logCount").textContent =
    rows.length===1 ? "1 entry" : `${rows.length} entries`;
}

function mkBtn(label, cls) {
  const b=document.createElement("button");
  b.type="button";
  b.className=cls||"";
  b.textContent=label;
  b.style.border="1px solid var(--border)";
  b.style.borderRadius="8px";
  b.style.padding="6px 10px";
  return b;
}

function addPlaceholder() {
  const tb=document.getElementById("logBody");
  const tr=document.createElement("tr");
  tr.id="placeholderRow";
  const td=document.createElement("td");
  td.colSpan=8;
  td.className="note";
  td.textContent="No entries yet — add one above.";
  tr.appendChild(td);
  tb.appendChild(tr);
}

function addRowFromData(item) {
  const tbody=document.getElementById("logBody");
  const tr=document.createElement("tr");

  const tdAct=document.createElement("td");
  const del=mkBtn("Delete","danger");
  del.onclick=()=>{
    tr.remove();
    if (!tbody.querySelector("tr")) addPlaceholder();
    updateLogCount();
    saveState();
  };
  tdAct.appendChild(del);
  tr.appendChild(tdAct);

  [
    item.dateDMY,
    item.job,
    item.leaveTime,
    item.returnTime,
    item.totalWorked,
    item.totalOT,
    item.otDue
  ].forEach(v=>{
    const td=document.createElement("td");
    td.textContent=v;
    tr.appendChild(td);
  });

  tbody.appendChild(tr);
}

function addRow() {
  const r = calc();
  const tbody=document.getElementById("logBody");
  const ph=document.getElementById("placeholderRow");
  if (ph) ph.remove();

  const isoDate = document.getElementById("date").value;
  const item = {
    dateDMY: toDMY(isoDate),
    job: document.getElementById("jobRef").value || "",
    leaveTime: document.getElementById("leaveTime").value || "",
    returnTime: document.getElementById("returnTime").value || "",
    totalWorked: fmtHours(r.totalWorked),
    totalOT: fmtHours(r.rawTotalOT),
    otDue: fmtMoney(r.otDue)
  };

  addRowFromData(item);
  updateLogCount();
  saveState();
}

function serializeLog() {
  const rows=[...document.querySelectorAll("#logBody tr")].filter(r=>!r.id);
  return rows.map(r=>{
    return {
      dateDMY: r.children[1].textContent.trim(),
      job:     r.children[2].textContent.trim(),
      leaveTime: r.children[3].textContent.trim(),
      returnTime: r.children[4].textContent.trim(),
      totalWorked: r.children[5].textContent.trim(),
      totalOT: r.children[6].textContent.trim(),
      otDue: r.children[7].textContent.trim()
    };
  });
}

function restoreLog(items) {
  const tbody=document.getElementById("logBody");
  tbody.innerHTML="";
  if (!items?.length) { addPlaceholder(); updateLogCount(); return; }
  items.forEach(addRowFromData);
  updateLogCount();
}

function clearLog() {
  if (!confirm("Clear all log entries?")) return;
  const tbody=document.getElementById("logBody");
  tbody.innerHTML="";
  addPlaceholder();
  updateLogCount();
  saveState();
}

/* ---------- EXPORT (WORD + PDF) ---------- */
function parseHM(s){
  if (!s) return 0;
  const m=s.match(/(\d+)h\s*(\d+)m/i);
  if (!m) return 0;
  return parseInt(m[1])*60 + parseInt(m[2]);
}
function parseMoney(s){
  if (!s) return 0;
  const n=s.replace(/[^0-9.\-]/g,"");
  return parseFloat(n||"0");
}
function buildDocHtmlFromLog(){
  const rows=[...document.querySelectorAll("#logBody tr")].filter(r=>!r.id);
  let totWorked=0, totOT=0, totDue=0;

  const bodyHtml = rows.map(r=>{
    const d=r.children[1].textContent.trim();
    const job=r.children[2].textContent.trim();
    const left=r.children[3].textContent.trim();
    const ret=r.children[4].textContent.trim();
    const tw=r.children[5].textContent.trim();
    const tot=r.children[6].textContent.trim();
    const due=r.children[7].textContent.trim();

    totWorked+=parseHM(tw);
    totOT+=parseHM(tot);
    totDue+=parseMoney(due);

    return `
      <tr>
        <td>${d}</td>
        <td>${job}</td>
        <td>${left}</td>
        <td>${ret}</td>
        <td class="tc">${tw}</td>
        <td class="tc">${tot}</td>
        <td class="tr">${due}</td>
      </tr>`;
  }).join("");

  const dates = rows.map(r=>r.children[1].textContent.trim()).filter(Boolean);
  const first = dates[0] || "";
  const last  = dates[dates.length-1] || "";

  const title = `Overtime Logs between ${first} and ${last}`;

  const css = `
    <style>
      @page { size: A4 landscape; margin: 1.6cm; }
      body { font-family: Calibri, Arial, sans-serif; font-size: 12pt; }
      h1 { font-size: 18pt; margin: 0 0 8pt 0; }
      h2 { font-size: 14pt; margin-top: 20pt; }
      table { border-collapse: collapse; width: 100%; margin-top: 12pt; }
      th, td {
        border: 1px solid #ccc;
        padding: 6pt;
        vertical-align: top;
      }
      th { background: #efefef; font-weight: bold; }
      .tc { text-align: center; }
      .tr { text-align: right; }
      .totals td { background: #f7f7f7; }
      ul { margin: 6pt 0 12pt 24pt; padding: 0; }
    </style>
  `;

  const totalsRow = rows.length ? `
    <tr class="totals">
      <td></td><td><b>Totals</b></td><td></td><td></td>
      <td class="tc"><b>${fmtHours(totWorked)}</b></td>
      <td class="tc"><b>${fmtHours(totOT)}</b></td>
      <td class="tr"><b>£${totDue.toFixed(2)}</b></td>
    </tr>` : "";

  return `
    <!doctype html>
    <html>
    <head><meta charset="utf-8">${css}<title>${title}</title></head>
    <body>
      <h1>${title}</h1>

      <h2>How the calculations work</h2>
      <ul>
        <li>Time before 09:00 and after 17:00 counts as overtime, based on recorded leave and return times.</li>
        <li>On field days, 15 minutes is deducted from pre-09:00 overtime and 15 minutes from post-17:00 overtime.</li>
        <li>On office-finish days, pre-09:00 overtime (after a 15 minute deduction) is kept, but there is no overtime after 17:00.</li>
        <li>Overtime is shown at the base rate (e.g. £15.70/hr).</li>
      </ul>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Job / Location</th>
            <th>Time left</th>
            <th>Time returned</th>
            <th>Total worked</th>
            <th>Total overtime</th>
            <th>OT Due</th>
          </tr>
        </thead>
        <tbody>
          ${bodyHtml || '<tr><td colspan="7">No entries</td></tr>'}
          ${totalsRow}
        </tbody>
      </table>

      <h2>Authorisation</h2>
      <p><b>Authorised by:</b> _____________________<br>
      <b>Date:</b> _____________________</p>
    </body>
    </html>
  `;
}

function exportWord(){
  const rows=[...document.querySelectorAll("#logBody tr")].filter(r=>!r.id);
  if (!rows.length) return alert("No rows to export.");
  const html=buildDocHtmlFromLog();

  const blob = new Blob([html], {
    type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"
  });
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="overtime_logs.docx";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    a.remove();
    URL.revokeObjectURL(url);
  },0);
}

function exportPdf(){
  const rows=[...document.querySelectorAll("#logBody tr")].filter(r=>!r.id);
  if (!rows.length) return alert("No rows to export.");
  const html=buildDocHtmlFromLog();
  const w=window.open("");
  w.document.write(html);
  w.document.close();
  w.onload = ()=>setTimeout(()=>w.print(),250);
}

/* ---------- API KEY PANEL ---------- */
function refreshApiKeyStatus(){
  const key=localStorage.getItem(OPENAI_KEY_STORAGE);
  document.getElementById("apiKeyStatus").textContent =
    key ? "API key stored." : "No API key stored.";
}
function handleSaveApiKey(){
  const v=document.getElementById("apiKeyInput").value.trim();
  if (!v) return alert("Enter key first");
  localStorage.setItem(OPENAI_KEY_STORAGE,v);
  document.getElementById("apiKeyInput").value="";
  refreshApiKeyStatus();
}
function handleClearApiKey(){
  localStorage.removeItem(OPENAI_KEY_STORAGE);
  refreshApiKeyStatus();
}

/* ---------- INIT ---------- */
window.addEventListener("DOMContentLoaded",()=>{
  logDebug("DOMContentLoaded");

  document.getElementById("signin").onclick = signIn;
  document.getElementById("fetchEvents").onclick = fetchEvents;
  document.getElementById("useSel").onclick = ()=>{
    const opt=document.getElementById("eventPick").selectedOptions[0];
    if (!opt) return;
    if (opt.textContent) document.getElementById("jobRef").value = opt.textContent.split(" — ")[0].trim();
    if (opt.dataset.date) document.getElementById("date").value = opt.dataset.date;
  };

  document.getElementById("calcBtn").onclick = calc;
  document.getElementById("addRowBtn").onclick = addRow;
  document.getElementById("clearLog").onclick = clearLog;
  document.getElementById("exportDoc").onclick = exportWord;
  document.getElementById("exportPdf").onclick = exportPdf;

  document.getElementById("saveApiKeyBtn").onclick = handleSaveApiKey;
  document.getElementById("clearApiKeyBtn").onclick = handleClearApiKey;
  refreshApiKeyStatus();

  loadState();
  updateDayTypeLabel(false,false);
});

function saveState(){
  const data={
    log: serializeLog(),
    baseRate: document.getElementById("baseRate").value,
    calendarId: document.getElementById("calendarId").value
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadState(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  const data=JSON.parse(raw);
  document.getElementById("baseRate").value = data.baseRate || "15.70";
  document.getElementById("calendarId").value = data.calendarId ||
    "bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com";
  if (Array.isArray(data.log)) restoreLog(data.log);
}
</script>
</body>
</html>