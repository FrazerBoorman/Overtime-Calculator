<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AVD OT Calculator — Stable + Calendar (Auto‑Fetch, v4)</title>
  <meta name="color-scheme" content="light dark">
  <meta name="google-oauth-client-id" content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com">
  <style>
    :root { --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#475569; --bg:#f8fafc; }
    @media (prefers-color-scheme: dark) {
      :root { --card:#0b1220; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --bg:#0f172a; }
    }
    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); }
    .wrap { padding: 18px; }
    .card { max-width: 1280px; margin: 0 auto; border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: var(--card); }
    h1 { margin: 0 0 10px 0; font-size: 22px; }
    h2 { margin: 16px 0 8px; font-size: 18px; display:flex; align-items:center; gap:8px; }
    label { font-weight: 600; font-size: 14px; display:block; margin-bottom: 6px; }
    input, select, button { font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text); width: 100%; }
    button { cursor: pointer; width: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .kpi { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-top: 12px; }
    .kpi > div { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .big { font-size: 20px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 14px; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid var(--border); padding: 10px; text-align: left; }
    th { background: var(--bg); }
    .badge { display:inline-block; font-size: 12px; border: 1px solid var(--border); padding: 2px 8px; border-radius: 999px; color: var(--muted); }
    .danger { border-color:#ef4444; color:#ef4444; }
    .primary { border-color:#2563eb; color:#2563eb; }
    .note { font-size: 12px; color: var(--muted); }
    .logbox { border: 2px dashed var(--border); border-radius: 10px; padding: 10px; background: var(--card); }
    .section-title { font-weight:700; font-size:14px; margin-bottom:6px; color:var(--muted); }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Daily Calculator – Grace(07:45–09:00) then Overtime(>17:00)</h1>
      <p class="muted">Leave fixed at <b>07:45</b>. 07:45–09:00 = grace/unpaid travel. After <b>17:00</b> is overtime.</p>

      <!-- Calendar controls -->
      <div class="section-title">Calendar</div>
      <div class="grid">
        <div>
          <label for="calendarId">Calendar ID</label>
          <input id="calendarId" value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com">
        </div>
        <div>
          <label for="fromDate">From</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label for="toDate">To</label>
          <input id="toDate" type="date">
        </div>
        <div style="align-self:end">
          <div class="btnrow">
            <button id="signin" class="primary" type="button">Sign in to Google</button>
            <button id="fetchEvents" type="button">Load last 7 days</button>
          </div>
          <div id="authStatus" class="note">Status: Not signed in</div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label for="eventPick">Recent events</label>
          <select id="eventPick">
            <option value="">— Select recent event (optional) —</option>
          </select>
        </div>
        <div style="align-self:end">
          <button id="useSel" type="button">Use selection</button>
          <div class="note">Picking an event auto-fills the Date and Job fields.</div>
        </div>
      </div>

    </div>
        <a href="https://frazerboorman.github.io/" class="pill">Frazer · AVD TOOLS</a>
      </div>
      
      <!-- Work-day inputs -->
      <div class="section-title" style="margin-top:14px">Daily inputs</div>
      <div class="grid">
        <div>
          <label for="jobRef">Job / Location</label>
          <input id="jobRef" placeholder="e.g. The Minster – Axminster – EX13 5AQ">
        </div>
        <div>
          <label for="date">Date</label>
          <input id="date" type="date">
        </div>
        <div>
          <label for="returnTime">Return home time</label>
          <input id="returnTime" type="time" step="300">
          <div class="note">Uses your device’s time setting (24‑hour if enabled).</div>
        </div>
        <div>
          <label for="baseRate">Base hourly rate (£)</label>
          <input id="baseRate" inputmode="decimal" value="15.70">
        </div>
      </div>

      <div class="btnrow">
        <button id="calcBtn" class="primary" type="button">Calculate</button>
        <button id="addRowBtn" type="button">Add results to table</button>
      </div>

      <!-- Results -->
      <h2>Results</h2>
      <div class="kpi">
        <div><div class="muted">Total worked (07:45 → return)</div><div class="big" id="allHours">—</div></div>
        <div><div class="muted">Grace window (unpaid)</div><div class="big" id="graceHours">—</div></div>
        <div><div class="muted">Core paid hours (09:00–17:00)</div><div class="big" id="coreHours">—</div></div>
        <div><div class="muted">Overtime hours (>17:00)</div><div class="big" id="otHours">—</div></div>
        <div><div class="muted">OT owed @ base rate</div><div class="big" id="otBase">—</div></div>
      </div>

      <!-- Log -->
      <h2 id="logHeader">LOG <span id="logCount" class="badge">0 entries</span></h2>
      <div id="logBox" class="logbox">
        <table id="logTable">
          <thead>
            <tr>
              <th style="width:120px">Actions</th>
              <th>Date</th>
              <th>Return time</th>
              <th>Job / Location</th>
              <th>Total worked</th>
              <th>Grace</th>
              <th>Core</th>
              <th>Overtime</th>
              <th>OT @ base</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <tr id="placeholderRow"><td colspan="9" class="note">No entries yet — add one above.</td></tr>
          </tbody>
        </table>
        <div class="btnrow">
          <button id="exportDoc" class="primary" type="button">Export to Word (.doc)</button>
          <button id="exportPdf" type="button">Export to PDF</button>
          <button id="clearLog" class="danger" type="button">Clear table</button>
        </div>
      </div>

      <p class="note" style="margin-top:12px">Authorisation is captured on the exported document only.</p>
    </div>
  </div>

  <script>
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
    let accessToken = null;
    let tokenClient = null;

    function setStatus(msg, ok) {
      const el = document.getElementById('authStatus');
      el.textContent = "Status: " + msg;
      el.className = "note " + (ok ? "ok" : "warn");
    }

    function initAuth() {
      if (!google || !google.accounts || !google.accounts.oauth2) return;
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: '',
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in", true);
            autoFetch();
          } else {
            setStatus("Sign-in failed", false);
          }
        }
      });
    }

    async function signIn() {
      if (!tokenClient) initAuth();
      if (!tokenClient) { setStatus("Auth library not ready. Try again.", false); return; }
      tokenClient.requestAccessToken();
    }

    function timeRangeISO(dateStr) {
      const [y,m,d] = dateStr.split('-').map(Number);
      const start = new Date(Date.UTC(y, m-1, d, 0,0,0));
      const end = new Date(Date.UTC(y, m-1, d, 23,59,59));
      return { timeMin: start.toISOString(), timeMax: end.toISOString() };
    }
    function spanISO(fromStr, toStr) {
      const { timeMin } = timeRangeISO(fromStr);
      const { timeMax } = timeRangeISO(toStr);
      return { timeMin, timeMax };
    }

    async function fetchEvents() {
      if (!accessToken) { setStatus("Sign in first", false); return; }
      const calId = (document.getElementById('calendarId').value || 'primary').trim();
      const fromStr = document.getElementById('fromDate').value.trim();
      const toStr = document.getElementById('toDate').value.trim();
      if (!fromStr || !toStr) { setStatus("Enter a date range", false); return; }
      const { timeMin, timeMax } = spanISO(fromStr, toStr);

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events`);
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');
      url.searchParams.set('timeMin', timeMin);
      url.searchParams.set('timeMax', timeMax);
      url.searchParams.set('maxResults', '2500');
      const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
      if (!res.ok) { setStatus(`API error ${res.status}`, false); return; }
      const data = await res.json();

      const sel = document.getElementById('eventPick');
      sel.innerHTML = '<option value="">— Select recent event (optional) —</option>';
      (data.items || []).forEach(ev => {
        const title = ev.summary || '(no title)';
        let dateStr = '';
        if (ev.start) {
          if (ev.start.date) dateStr = ev.start.date;
          else if (ev.start.dateTime) dateStr = ev.start.dateTime.slice(0,10);
        }
        const opt = document.createElement('option');
        opt.value = title;
        opt.textContent = title + (dateStr ? `  —  ${dateStr}` : '');
        if (dateStr) opt.dataset.date = dateStr;
        sel.appendChild(opt);
      });
      setStatus(`Loaded ${(data.items||[]).length} events`, true);
    }

    function autoFetch() { fetchEvents().catch(() => {}); }

    const STORAGE_KEY = 'avd_ot_stable_calendar_autofetch_v4';
    function saveState() {
      const data = {
        log: serializeLog(),
        baseRate: document.getElementById('baseRate').value || '',
        calendarId: document.getElementById('calendarId').value || '',
        fromDate: document.getElementById('fromDate').value || '',
        toDate: document.getElementById('toDate').value || ''
      };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
    }
    function loadState() {
      let raw = null;
      try { raw = localStorage.getItem(STORAGE_KEY); } catch(e) {}
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data.baseRate) document.getElementById('baseRate').value = data.baseRate;
        if (data.calendarId) document.getElementById('calendarId').value = data.calendarId;
        if (data.fromDate) document.getElementById('fromDate').value = data.fromDate;
        if (data.toDate) document.getElementById('toDate').value = data.toDate;
        if (Array.isArray(data.log)) restoreLog(data.log);
      } catch(e) {}
    }

    const LEAVE_MIN = 7*60 + 45; // 07:45
    const GRACE_END = 9*60;      // 09:00
    const CORE_END  = 17*60;     // 17:00

    function ensureDefaults() {
      const now = new Date();
      const fmt = d => d.toISOString().slice(0,10);
      if (!document.getElementById('date').value) document.getElementById('date').value = fmt(now);
      const rt = document.getElementById('returnTime');
      if (!rt.value) {
        const hh = String(now.getHours()).padStart(2,'0');
        const mm = String(Math.round(now.getMinutes()/5)*5).padStart(2,'0');
        rt.value = `${hh}:${mm}`;
      }
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
      const start = new Date(end); start.setDate(start.getDate() - 6); start.setHours(0,0,0,0);
      if (!document.getElementById('fromDate').value) document.getElementById('fromDate').value = fmt(start);
      if (!document.getElementById('toDate').value) document.getElementById('toDate').value = fmt(end);
      const calEl = document.getElementById('calendarId');
      if (!calEl.value) calEl.value = "bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com";
    }

    function minutesFromHHMM(v){ if(!v) return null; const [hh, mm] = v.split(':').map(Number); if(Number.isNaN(hh) || Number.isNaN(mm)) return null; return hh*60 + mm; }
    function fmtHours(mins){ if(mins==null||isNaN(mins))return '—'; const h=Math.floor(mins/60); const m=Math.round(mins%60); return `${h}h ${String(m).padStart(2,'0')}m`; }
    function fmtMoney(pounds){ if(pounds==null||isNaN(pounds))return '—'; return `£${pounds.toFixed(2)}`; }

    function calc(){
      const pick = document.getElementById('eventPick');
      if (pick && pick.value) {
        const opt = pick.selectedOptions && pick.selectedOptions[0];
        if (opt) {
          document.getElementById('jobRef').value = opt.textContent.trim();
          if (opt.dataset.date) document.getElementById('date').value = opt.dataset.date;
        }
      }

      const rtVal = document.getElementById('returnTime').value;
      const baseRate = parseFloat((document.getElementById('baseRate').value || '15.70').replace(',','.'));
      let endMin = minutesFromHHMM(rtVal);
      if(endMin==null){ alert('Select a valid return time.'); return; }
      if(endMin < LEAVE_MIN) endMin += 24*60;

      const totalWorked = Math.max(0, endMin - LEAVE_MIN);
      const grace = Math.max(0, Math.min(endMin, GRACE_END) - LEAVE_MIN);
      let core=0;
      if(endMin <= GRACE_END) core=0;
      else if(endMin < CORE_END) core=endMin-GRACE_END;
      else core=CORE_END-GRACE_END;
      if(core<0) core=0;
      const ot = Math.max(0, endMin - CORE_END);
      const otBase = (ot/60)*baseRate;

      document.getElementById('allHours').textContent = fmtHours(totalWorked);
      document.getElementById('graceHours').textContent = fmtHours(grace);
      document.getElementById('coreHours').textContent = fmtHours(core);
      document.getElementById('otHours').textContent = fmtHours(ot);
      document.getElementById('otBase').textContent = fmtMoney(otBase);
    }

    function updateLogCount() {
      const rows = Array.from(document.querySelectorAll('#logBody tr')).filter(r => !r.id);
      const badge = document.getElementById('logCount');
      const n = rows.length;
      badge.textContent = n === 1 ? '1 entry' : `${n} entries`;
    }
    function mkBtn(label, className) {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = className || '';
      b.textContent = label;
      b.style.border = '1px solid var(--border)';
      b.style.borderRadius = '8px';
      b.style.padding = '6px 10px';
      return b;
    }
    function addPlaceholder(){
      const tbody = document.getElementById('logBody');
      const tr = document.createElement('tr');
      tr.id = 'placeholderRow';
      const td = document.createElement('td');
      td.colSpan = 9; td.className = 'note'; td.textContent = 'No entries yet — add one above.';
      tr.appendChild(td); tbody.appendChild(tr);
    }
    function addRowFromData(item) {
      const tbody = document.getElementById('logBody');
      const tr = document.createElement('tr');
      const tdAct = document.createElement('td');
      const del = mkBtn('Delete', 'danger');
      del.addEventListener('click', () => { tr.remove(); if(!tbody.querySelector('tr')) addPlaceholder(); updateLogCount(); saveState(); });
      tdAct.appendChild(del); tr.appendChild(tdAct);
      [item.date, item.returnTime, item.job, item.total, item.grace, item.core, item.ot, item.otBase].forEach(txt => {
        const td = document.createElement('td'); td.textContent = txt || ''; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    function addRow() {
      calc();
      const tbody = document.getElementById('logBody');
      const ph = document.getElementById('placeholderRow'); if (ph) ph.remove();
      const item = {
        date: document.getElementById('date').value || '',
        returnTime: document.getElementById('returnTime').value || '',
        job: document.getElementById('jobRef').value || '',
        total: document.getElementById('allHours').textContent || '',
        grace: document.getElementById('graceHours').textContent || '',
        core: document.getElementById('coreHours').textContent || '',
        ot: document.getElementById('otHours').textContent || '',
        otBase: document.getElementById('otBase').textContent || ''
      };
      addRowFromData(item);
      updateLogCount();
      saveState();
      document.getElementById('logHeader').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    function clearLog() {
      const tbody = document.getElementById('logBody');
      tbody.innerHTML = ''; addPlaceholder(); updateLogCount(); saveState();
    }

    function serializeLog() {
      const rows = Array.from(document.querySelectorAll('#logBody tr')).filter(r => !r.id);
      return rows.map(r => ({ 
        date: r.children[1].textContent.trim(),
        returnTime: r.children[2].textContent.trim(),
        job: r.children[3].textContent.trim(),
        total: r.children[4].textContent.trim(),
        grace: r.children[5].textContent.trim(),
        core: r.children[6].textContent.trim(),
        ot: r.children[7].textContent.trim(),
        otBase: r.children[8].textContent.trim()
      }));
    }
    function restoreLog(items) {
      const tbody = document.getElementById('logBody');
      tbody.innerHTML='';
      if (!items || !items.length) { addPlaceholder(); updateLogCount(); return; }
      items.forEach(addRowFromData);
      updateLogCount();
    }

    function parseHM(s) {
      if (!s) return 0;
      const m = s.match(/(\d+)h\s*(\d+)m/i);
      if (!m) return 0;
      return parseInt(m[1],10)*60 + parseInt(m[2],10);
    }
    function fmtHM(mins) {
      const h = Math.floor(mins/60);
      const m = Math.round(mins%60);
      return `${h}h ${String(m).padStart(2,'0')}m`;
    }
    function parseMoney(s) {
      if (!s) return 0;
      const v = s.replace(/[^0-9.\-]/g,''); 
      return parseFloat(v || '0');
    }
    function buildDocHtmlFromLog() {
      const colWidths = ["12%","10%","34%","11%","8%","8%","9%","8%"];
      const headCells = ["Date","Return time","Job / Location","Total worked","Grace","Core","Overtime","OT @ base"];
      
      const rows = Array.from(document.querySelectorAll('#logBody tr')).filter(r => !r.id);
      let totTotal=0, totGrace=0, totCore=0, totOT=0, totMoney=0;
      const bodyRowsHtml = rows.map(r => {
        const date = r.children[1].textContent.trim();
        const rt   = r.children[2].textContent.trim();
        const job  = r.children[3].textContent.trim();
        const total= r.children[4].textContent.trim();
        const grace= r.children[5].textContent.trim();
        const core = r.children[6].textContent.trim();
        const ot   = r.children[7].textContent.trim();
        const base = r.children[8].textContent.trim();
        totTotal += parseHM(total);
        totGrace += parseHM(grace);
        totCore  += parseHM(core);
        totOT    += parseHM(ot);
        totMoney += parseMoney(base);
        return `<tr>
          <td>${date}</td>
          <td>${rt}</td>
          <td>${job}</td>
          <td class="tc">${total}</td>
          <td class="tc">${grace}</td>
          <td class="tc">${core}</td>
          <td class="tc">${ot}</td>
          <td class="tr">${base}</td>
        </tr>`;
      }).join("");
      
      const totalsRow = `<tr class="totals">
        <td></td>
        <td></td>
        <td><b>Totals</b></td>
        <td class="tc"><b>${fmtHM(totTotal)}</b></td>
        <td class="tc"><b>${fmtHM(totGrace)}</b></td>
        <td class="tc"><b>${fmtHM(totCore)}</b></td>
        <td class="tc"><b>${fmtHM(totOT)}</b></td>
        <td class="tr"><b>£${totMoney.toFixed(2)}</b></td>
      </tr>`;

      const dates = rows.map(r => r.children[1].textContent.trim()).filter(Boolean).sort();
      const title = dates.length ? `Overtime Logs between ${dates[0]} and ${dates[dates.length-1]}` : 'Overtime Logs';

      const css = `<style>
        @page { size: A4 landscape; margin: 1.6cm; }
        body { font-family: Calibri, Arial, sans-serif; font-size: 12pt; color: #000; }
        h1 { font-size: 18pt; margin: 0 0 8pt 0; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #cccccc; padding: 6pt; vertical-align: top; }
        th { background: #efefef; font-weight: bold; }
        .tc { text-align: center; }
        .tr { text-align: right; }
        .totals td { background: #f7f7f7; }
        .explain { margin: 0 0 10pt 0; }
        .auth { margin-top: 14pt; }
      </style>`;

      const colgroup = `<colgroup>${colWidths.map(w => `<col style="width:${w}">`).join("")}</colgroup>`;
      const thead = `<thead><tr>${headCells.map(h => `<th>${h}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${bodyRowsHtml || `<tr><td colspan="8">No entries</td></tr>`}${rows.length?totalsRow:""}</tbody>`;

      const explain = `<div class="explain">
        <p><b>How the calculations work</b></p>
        <ul style="margin:0 0 6pt 18pt;padding:0">
          <li>Leave fixed at 07:45</li>
          <li>07:45–09:00 grace/unpaid</li>
          <li>09:00–17:00 core paid</li>
          <li>After 17:00 overtime</li>
          <li>OT shown at base rate (£15.70/hr)</li>
        </ul>
      </div>`;

      const auth = `<div class="auth">
        <h2>Authorisation</h2>
        <p><b>Authorised by:</b> _____________________<br>
        <b>Date:</b> _____________________</p>
      </div>`;

      return `<!doctype html>
<html>
<head><meta charset="utf-8"><title>${title}</title>${css}</head>
<body>
  <h1>${title}</h1>
  ${explain}
  <table>
    ${colgroup}
    ${thead}
    ${tbody}
  </table>
  ${auth}
</body>
</html>`;
    }

    function exportWord() {
      const rows = Array.from(document.querySelectorAll('#logBody tr')).filter(r => !r.id);
      if (!rows.length) { alert('No rows to export. Add rows first.'); return; }
      const html = buildDocHtmlFromLog();
      const titleMatch = html.match(/<title>(.*?)<\/title>/i);
      const fname = (titleMatch ? titleMatch[1] : 'overtime_logs').replace(/\s+/g,'_').toLowerCase()+'.doc';
      const blob = new Blob([html], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click();
      setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},0);
    }

    function exportPdf() {
      const rows = Array.from(document.querySelectorAll('#logBody tr')).filter(r => !r.id);
      if (!rows.length) { alert('No rows to export. Add rows first.'); return; }
      const html = buildDocHtmlFromLog();
      const w = window.open('', '_blank');
      if (!w) { alert('Pop-up blocked. Allow pop-ups for this site to export PDF.'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      // Wait for styles to apply, then print
      w.onload = () => { setTimeout(() => { w.print(); }, 250); };
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      ensureDefaults();
      loadState();
      window.addEventListener('load', () => { try { initAuth(); tokenClient && tokenClient.requestAccessToken(); } catch(e) {} });
      document.getElementById('signin').addEventListener('click', signIn);
      document.getElementById('fetchEvents').addEventListener('click', fetchEvents);
      document.getElementById('useSel').addEventListener('click', () => {
        const pick = document.getElementById('eventPick');
        const jobRef = document.getElementById('jobRef');
        const dateEl = document.getElementById('date');
        if (pick.value) { jobRef.value = (pick.selectedOptions[0]?.textContent || pick.value).trim(); }
        const d = pick.selectedOptions && pick.selectedOptions[0] && pick.selectedOptions[0].dataset.date;
        if (d) dateEl.value = d;
      });
      document.getElementById('eventPick').addEventListener('change', (e) => {
        const opt = e.target.selectedOptions && e.target.selectedOptions[0];
        if (!opt) return;
        if (opt.textContent) document.getElementById('jobRef').value = opt.textContent.trim();
        if (opt.dataset.date) document.getElementById('date').value = opt.dataset.date;
      });
      document.getElementById('calcBtn').addEventListener('click', calc);
      document.getElementById('addRowBtn').addEventListener('click', addRow);
      document.getElementById('clearLog').addEventListener('click', clearLog);
      document.getElementById('exportDoc').addEventListener('click', exportWord);
      document.getElementById('exportPdf').addEventListener('click', exportPdf);
      ['baseRate','calendarId','fromDate','toDate'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('change', saveState);
        el.addEventListener('input', saveState);
      });
      updateLogCount();
    });
  </script>
</body>
</html>
