<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AVD OT Calculator – Stable + Calendar (Auto-Fetch, v4.3)</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }

    * { box-sizing:border-box; }
    html, body { height:100%; }

    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin:0 auto;
      padding:18px;
    }

    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 22px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
      margin-bottom:16px;
    }

    h1 {
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }

    h2 {
      margin:16px 0 8px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .version {
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .muted { color:var(--muted); font-size:14px; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      text-decoration:none;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, color .12s ease,
                  transform .06s ease, box-shadow .12s ease;
    }
    .pill:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      transform:translateY(-0.5px);
      box-shadow:0 3px 8px rgba(15,23,42,0.35);
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }

    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }

    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input, select, textarea, button {
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      box-sizing:border-box;
    }

    input, select, textarea {
      width:100%;
    }
    textarea { resize:vertical; min-height:70px; }

    input::placeholder, textarea::placeholder { color:var(--muted); }

    .small-note,
    .note {
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .btn-row, .btnrow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    button {
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }

    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }

    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .danger {
      border-color:var(--danger) !important;
      color:var(--danger);
    }

    /* KPI cards */
    .kpi {
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top:12px;
    }
    .kpi > div {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
    }
    .big { font-size:20px; font-weight:700; }

    /* Log / table */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:10px;
    }
    th, td {
      border:1px solid var(--border);
      padding:6px 8px;
      vertical-align:top;
      text-align:left;
    }
    th {
      background:rgba(15,23,42,0.6);
      font-weight:600;
    }
    @media (prefers-color-scheme: light) {
      th { background:#e5e7eb; }
    }

    .logbox {
      border:2px dashed var(--border);
      border-radius:10px;
      padding:10px;
      background:var(--panel);
    }

    .badge {
      display:inline-block;
      font-size:12px;
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:999px;
      color:var(--muted);
    }

    /* Debug & API & Calendar settings panels */
    details.debug,
    details.api,
    details.calendar-settings,
    details.calendar-range,
    details.calendar-day-select {
      margin-top:10px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:8px 10px;
      background:rgba(15,23,42,0.4);
      font-size:11px;
    }
    @media (prefers-color-scheme: light) {
      details.debug,
      details.api,
      details.calendar-settings,
      details.calendar-range,
      details.calendar-day-select { background:#f3f4f6; }
    }

    details.debug summary,
    details.api summary,
    details.calendar-settings summary,
    details.calendar-range summary,
    details.calendar-day-select summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }

    details.debug pre {
      white-space:pre-wrap;
      font-size:11px;
      margin-top:4px;
    }

    .danger-text { color:var(--danger); }

    .flag-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      font-size:12px;
    }
    .flag-row label {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      margin-bottom:0;
    }
    .flag-row input[type="checkbox"] {
      width:auto;
      accent-color:var(--accent);
    }

    .day-type-label {
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Header with version + pill -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            AVD Overtime Calculator
            <span class="version">v4.3</span>
          </h1>
          <div class="muted">
            Daily calculator: leave defaults to <strong>07:45</strong> (adjustable below).
            Time before <strong>09:00</strong> and after <strong>17:00</strong> counts as overtime,
            with a <strong>15 minute</strong> deduction each side on field days.
            Full office/admin and office-finish days can be flagged to adjust overtime.
          </div>
        </div>
        <a href="https://frazerboorman.github.io/" class="pill">Frazer · AVD TOOLS</a>
      </div>

      <!-- STEP 1 – Calendar -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar</div>
        <div class="grid">
          <div style="align-self:end;">
            <div class="btnrow">
              <button id="signin" class="primary" type="button">Sign in to Google</button>
              <button id="fetchEvents" type="button">Load last 7 days (incl. today)</button>
            </div>
            <div id="authStatus" class="note">Status: Not signed in</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label for="eventPick">Recent events (newest first)</label>
            <select id="eventPick">
              <option value="">— Select recent event (optional) —</option>
            </select>
          </div>
          <div style="align-self:end;">
            <button id="useSel" type="button">Use selection</button>
            <div class="note">Picking an event auto-fills the Date and Job fields.</div>
          </div>
        </div>

        <!-- Advanced calendar date range -->
        <details class="calendar-range">
          <summary>Advanced: calendar date range (defaults to last 7 days including today)</summary>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label for="fromDate">From</label>
              <input id="fromDate" type="date" />
            </div>
            <div>
              <label for="toDate">To</label>
              <input id="toDate" type="date" />
            </div>
          </div>
          <div class="small-note" style="margin-top:6px;">
            These dates reflect the current 7-day window used for the events above.
          </div>
        </details>

        <!-- Hidden: single-day selector -->
        <details class="calendar-day-select">
          <summary>Hidden: load events for a specific day</summary>
          <div style="margin-top:8px;max-width:260px;">
            <label for="singleDay">Day</label>
            <input id="singleDay" type="date" />
            <div class="small-note">
              Loads only events from this single day into the dropdown above.
            </div>
            <button id="fetchSingleDay" type="button" style="margin-top:8px;">Load this day only</button>
          </div>
        </details>
      </div>

      <!-- STEP 2 – Daily inputs -->
      <div class="section">
        <div class="section-title">Step 2 – Daily inputs</div>
        <div class="grid">
          <div>
            <label for="jobRef">Job / Location</label>
            <input id="jobRef" placeholder="e.g. The Minster – Axminster – EX13 5AQ" />
          </div>
          <div>
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="leaveTime">Leave home time</label>
            <input id="leaveTime" type="time" step="300" />
            <div class="note">Defaults to 07:45 if left blank.</div>
          </div>
          <div>
            <label for="returnTime">Return home time</label>
            <input id="returnTime" type="time" step="300" />
            <div class="note">Uses your device’s time setting (24-hour if enabled).</div>
          </div>
          <div>
            <label for="baseRate">Base hourly rate (£)</label>
            <input id="baseRate" inputmode="decimal" value="15.70" />
          </div>
        </div>

        <div class="flag-row">
          <label>
            <input type="checkbox" id="fullOfficeDay" />
            Full office/admin day (no overtime at all)
          </label>
          <label>
            <input type="checkbox" id="officeFinishDay" />
            Returned to office by ~16:00 and worked there until 17:00 (no overtime after 17:00)
          </label>
        </div>

        <div class="btnrow">
          <button id="calcBtn" class="primary" type="button">Calculate</button>
          <button id="addRowBtn" type="button">Add results to table</button>
        </div>
      </div>

      <!-- STEP 3 – Results -->
      <div class="section">
        <div class="section-title">Step 3 – Results</div>
        <div class="kpi">
          <div>
            <div class="muted">Total worked (leave → end of work)</div>
            <div class="big" id="allHours">—</div>
          </div>
          <div>
            <div class="muted">Pre-09:00 overtime (after 15m deduction)</div>
            <div class="big" id="graceHours">—</div>
          </div>
          <div>
            <div class="muted">Core paid hours (09:00–17:00)</div>
            <div class="big" id="coreHours">—</div>
          </div>
          <div>
            <div class="muted">Post-17:00 overtime (after 15m deduction)</div>
            <div class="big" id="otHours">—</div>
          </div>
          <div>
            <div class="muted">Total OT owed @ base rate</div>
            <div class="big" id="otBase">—</div>
          </div>
        </div>
        <div id="dayTypeLabel" class="day-type-label">Day type: —</div>
      </div>

      <!-- STEP 4 – Log & export -->
      <div class="section">
        <div class="section-title">Step 4 – Log & export</div>
        <h2 id="logHeader">LOG <span id="logCount" class="badge">0 entries</span></h2>
        <div id="logBox" class="logbox">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width:120px;">Actions</th>
                <th>Date</th>
                <th>Return time</th>
                <th>Job / Location</th>
                <th>Total worked</th>
                <th>Pre-09 OT</th>
                <th>Core</th>
                <th>Post-17 OT</th>
                <th>OT @ base</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr id="placeholderRow">
                <td colspan="9" class="note">No entries yet — add one above.</td>
              </tr>
            </tbody>
          </table>
          <div class="btnrow">
            <button id="exportDoc" class="primary" type="button">Export to Word (.docx)</button>
            <button id="exportPdf" type="button">Export to PDF</button>
            <button id="clearLog" class="danger" type="button">Clear table</button>
          </div>
        </div>

        <p class="note" style="margin-top:12px;">
          Authorisation is captured on the exported document only.
        </p>
      </div>
    </div>

    <!-- Global debug panel -->
    <details class="debug">
      <summary>Debug panel</summary>
      <pre id="debugLog">(empty)</pre>
    </details>

    <!-- Calendar settings (Calendar ID hidden by default) -->
    <details class="calendar-settings">
      <summary>Calendar settings (Calendar ID)</summary>
      <div class="small-note" style="margin-top:4px;">
        Advanced: change which Google Calendar this tool reads from. Usually leave as-is.
      </div>
      <div style="margin-top:6px;max-width:460px;">
        <label for="calendarId">Calendar ID</label>
        <input id="calendarId"
               value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
        <div class="small-note">
          Same shared calendar you use in the other AVD tools.
        </div>
      </div>
    </details>

    <!-- API KEY PANEL (OpenAI – shared with other tools) -->
    <details class="api">
      <summary>API key (OpenAI) – hidden by default</summary>
      <div class="small-note" style="margin-top:4px;">
        Stored locally in <code>localStorage['avd_job_report_openai_key']</code>. Not sent anywhere except OpenAI’s API.
        This overtime tool doesn’t call OpenAI yet, but shares the same key as the other tools.
      </div>
      <div style="display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap;">
        <input id="apiKeyInput" type="password" placeholder="sk-..." style="flex:1 1 220px;max-width:380px;" />
        <button type="button" id="saveApiKeyBtn">Save</button>
        <button type="button" id="clearApiKeyBtn">Forget</button>
      </div>
      <div id="apiKeyStatus" class="small-note"></div>
    </details>
  </div>

  <script>
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
    let accessToken = null;
    let tokenClient = null;

    const STORAGE_KEY = "avd_ot_stable_calendar_autofetch_v4"; // keep same key for now
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";

    const GRACE_END = 9*60;      // 09:00
    const CORE_END  = 17*60;     // 17:00

    // ========== Calendar & Fetch Logic ==========
    function initAuth() {
      if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
        logDebug("initAuth: Google auth library not ready yet.");
        return;
      }
      tokenClient = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: "",
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in", true);
            autoFetch();
          } else {
            setStatus("Sign-in failed", false);
          }
        }
      });
      logDebug("initAuth: tokenClient initialised.");
    }

    async function signIn() {
      logDebug("signIn: clicked.");
      if (!tokenClient) initAuth();
      if (!tokenClient) {
        setStatus("Auth library not ready. Try again.", false);
        return;
      }
      tokenClient.requestAccessToken();
    }

    async function fetchEvents() {
      logDebug("fetchEvents: start.");
      if (!accessToken) { setStatus("Sign in first", false); return; }

      const calId = (document.getElementById("calendarId").value || "primary").trim();
      const fromStr = document.getElementById("fromDate").value.trim();
      const toStr = document.getElementById("toDate").value.trim();
      if (!fromStr || !toStr) {
        setStatus("No date range set", false);
        return;
      }
      const { timeMin, timeMax } = spanISO(fromStr, toStr);

      const url = new URL(
        "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(calId) +
        "/events"
      );
      url.searchParams.set("singleEvents", "true");
      url.searchParams.set("orderBy", "startTime");
      url.searchParams.set("timeMin", timeMin);
      url.searchParams.set("timeMax", timeMax);
      url.searchParams.set("maxResults", "2500");

      const res = await fetch(url, { headers: { Authorization: "Bearer " + accessToken } });
      if (!res.ok) { setStatus("API error " + res.status, false); return; }
      const data = await res.json();

      const sel = document.getElementById("eventPick");
      sel.innerHTML = '<option value="">— Select recent event (optional) —</option>';

      // Sort events so most recent start time is first
      const items = (data.items || []).slice().sort((a, b) => {
        const aStart = a.start ? (a.start.dateTime || a.start.date) : null;
        const bStart = b.start ? (b.start.dateTime || b.start.date) : null;
        if (!aStart && !bStart) return 0;
        if (!aStart) return 1;
        if (!bStart) return -1;
        return new Date(bStart) - new Date(aStart);
      });

      items.forEach(ev => {
        const title = ev.summary || "(no title)";
        let dateStr = "";
        if (ev.start) {
          if (ev.start.date) dateStr = ev.start.date;
          else if (ev.start.dateTime) dateStr = ev.start.dateTime.slice(0,10);
        }
        const opt = document.createElement("option");
        opt.value = title;
        opt.textContent = title + (dateStr ? "  —  " + dateStr : "");
        if (dateStr) opt.dataset.date = dateStr;
        sel.appendChild(opt);
      });
      setStatus("Loaded " + items.length + " events", true);
    }

    function autoFetch() {
      logDebug("autoFetch: attempting to fetch events after sign-in.");
      fetchEvents().catch(err => {
        logDebug("autoFetch error: " + (err && err.message ? err.message : String(err)));
      });
    }

    // ========= Export Helper =========
    function exportWord() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      if (!rows.length) { alert("No rows to export. Add rows first."); return; }
      const html = buildDocHtmlFromLog();
      const titleMatch = html.match(/<title>(.*?)<\/title>/i);
      const fname = (titleMatch ? titleMatch[1] : "overtime_logs").replace(/\s+/g,"_").toLowerCase() + ".docx";
      const blob = new Blob([html], {
        type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function exportPdf() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      if (!rows.length) { alert("No rows to export. Add rows first."); return; }
      const html = buildDocHtmlFromLog();
      const w = window.open("", "_blank");
      if (!w) { alert("Pop-up blocked. Allow pop-ups for this site to export PDF."); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.onload = () => { setTimeout(() => { w.print(); }, 250); };
    }
  </script>
</body>
</html>
