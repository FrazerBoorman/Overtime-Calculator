<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AVD OT Calculator – Stable + Calendar (Auto-Fetch, v4.2)</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }

    * { box-sizing:border-box; }
    html, body { height:100%; }

    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin:0 auto;
      padding:18px;
    }

    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 22px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
      margin-bottom:16px;
    }

    h1 {
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }

    h2 {
      margin:16px 0 8px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .version {
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .muted { color:var(--muted); font-size:14px; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      text-decoration:none;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, color .12s ease,
                  transform .06s ease, box-shadow .12s ease;
    }
    .pill:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      transform:translateY(-0.5px);
      box-shadow:0 3px 8px rgba(15,23,42,0.35);
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }

    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }

    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input, select, textarea, button {
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      box-sizing:border-box;
    }

    input, select, textarea {
      width:100%;
    }
    textarea { resize:vertical; min-height:70px; }

    input::placeholder, textarea::placeholder { color:var(--muted); }

    .small-note,
    .note {
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .btn-row, .btnrow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    button {
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }

    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }

    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .danger {
      border-color:var(--danger) !important;
      color:var(--danger);
    }

    /* KPI cards */
    .kpi {
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top:12px;
    }
    .kpi > div {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
    }
    .big { font-size:20px; font-weight:700; }

    /* Log / table */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:10px;
    }
    th, td {
      border:1px solid var(--border);
      padding:6px 8px;
      vertical-align:top;
      text-align:left;
    }
    th {
      background:rgba(15,23,42,0.6);
      font-weight:600;
    }
    @media (prefers-color-scheme: light) {
      th { background:#e5e7eb; }
    }

    .logbox {
      border:2px dashed var(--border);
      border-radius:10px;
      padding:10px;
      background:var(--panel);
    }

    .badge {
      display:inline-block;
      font-size:12px;
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:999px;
      color:var(--muted);
    }

    /* Debug & API & Calendar settings panels */
    details.debug,
    details.api,
    details.calendar-settings,
    details.calendar-range {
      margin-top:10px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:8px 10px;
      background:rgba(15,23,42,0.4);
      font-size:11px;
    }
    @media (prefers-color-scheme: light) {
      details.debug,
      details.api,
      details.calendar-settings,
      details.calendar-range { background:#f3f4f6; }
    }

    details.debug summary,
    details.api summary,
    details.calendar-settings summary,
    details.calendar-range summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }

    details.debug pre {
      white-space:pre-wrap;
      font-size:11px;
      margin-top:4px;
    }

    .danger-text { color:var(--danger); }

    .flag-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      font-size:12px;
    }
    .flag-row label {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      margin-bottom:0;
    }
    .flag-row input[type="checkbox"] {
      width:auto;
      accent-color:var(--accent);
    }

    .day-type-label {
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Header with version + pill -->
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            AVD Overtime Calculator
            <span class="version">v4.2</span>
          </h1>
          <div class="muted">
            Daily calculator: leave defaults to <strong>07:45</strong> (adjustable below).
            Time before <strong>09:00</strong> and after <strong>17:00</strong> counts as overtime,
            with a <strong>15 minute</strong> deduction each side on field days.
            Full office/admin and office-finish days can be flagged to adjust overtime.
          </div>
        </div>
        <a href="https://frazerboorman.github.io/" class="pill">Frazer · AVD TOOLS</a>
      </div>

      <!-- STEP 1 – Calendar -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar</div>
        <div class="grid">
          <div style="align-self:end;">
            <div class="btnrow">
              <button id="signin" class="primary" type="button">Sign in to Google</button>
              <button id="fetchEvents" type="button">Load last 7 days</button>
            </div>
            <div id="authStatus" class="note">Status: Not signed in</div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label for="eventPick">Recent events (newest first)</label>
            <select id="eventPick">
              <option value="">— Select recent event (optional) —</option>
            </select>
          </div>
          <div style="align-self:end;">
            <button id="useSel" type="button">Use selection</button>
            <div class="note">Picking an event auto-fills the Date and Job fields.</div>
          </div>
        </div>

        <!-- Advanced calendar date range -->
        <details class="calendar-range">
          <summary>Advanced: calendar date range (defaults to last 7 days including today)</summary>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label for="fromDate">From</label>
              <input id="fromDate" type="date" />
            </div>
            <div>
              <label for="toDate">To</label>
              <input id="toDate" type="date" />
            </div>
          </div>
          <div class="small-note" style="margin-top:6px;">
            These dates control which events are shown in the dropdown above.
          </div>
        </details>
      </div>

      <!-- STEP 2 – Daily inputs -->
      <div class="section">
        <div class="section-title">Step 2 – Daily inputs</div>
        <div class="grid">
          <div>
            <label for="jobRef">Job / Location</label>
            <input id="jobRef" placeholder="e.g. The Minster – Axminster – EX13 5AQ" />
          </div>
          <div>
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="leaveTime">Leave home time</label>
            <input id="leaveTime" type="time" step="300" />
            <div class="note">Defaults to 07:45 if left blank.</div>
          </div>
          <div>
            <label for="returnTime">Return home time</label>
            <input id="returnTime" type="time" step="300" />
            <div class="note">Uses your device’s time setting (24-hour if enabled).</div>
          </div>
          <div>
            <label for="baseRate">Base hourly rate (£)</label>
            <input id="baseRate" inputmode="decimal" value="15.70" />
          </div>
        </div>

        <div class="flag-row">
          <label>
            <input type="checkbox" id="fullOfficeDay" />
            Full office/admin day (no overtime at all)
          </label>
          <label>
            <input type="checkbox" id="officeFinishDay" />
            Returned to office by ~16:00 and worked there until 17:00 (no overtime after 17:00)
          </label>
        </div>

        <div class="btnrow">
          <button id="calcBtn" class="primary" type="button">Calculate</button>
          <button id="addRowBtn" type="button">Add results to table</button>
        </div>
      </div>

      <!-- STEP 3 – Results -->
      <div class="section">
        <div class="section-title">Step 3 – Results</div>
        <div class="kpi">
          <div>
            <div class="muted">Total worked (leave → end of work)</div>
            <div class="big" id="allHours">—</div>
          </div>
          <div>
            <div class="muted">Pre-09:00 overtime (after 15m deduction)</div>
            <div class="big" id="graceHours">—</div>
          </div>
          <div>
            <div class="muted">Core paid hours (09:00–17:00)</div>
            <div class="big" id="coreHours">—</div>
          </div>
          <div>
            <div class="muted">Post-17:00 overtime (after 15m deduction)</div>
            <div class="big" id="otHours">—</div>
          </div>
          <div>
            <div class="muted">Total OT owed @ base rate</div>
            <div class="big" id="otBase">—</div>
          </div>
        </div>
        <div id="dayTypeLabel" class="day-type-label">Day type: —</div>
      </div>

      <!-- STEP 4 – Log & export -->
      <div class="section">
        <div class="section-title">Step 4 – Log & export</div>
        <h2 id="logHeader">LOG <span id="logCount" class="badge">0 entries</span></h2>
        <div id="logBox" class="logbox">
          <table id="logTable">
            <thead>
              <tr>
                <th style="width:120px;">Actions</th>
                <th>Date</th>
                <th>Return time</th>
                <th>Job / Location</th>
                <th>Total worked</th>
                <th>Pre-09 OT</th>
                <th>Core</th>
                <th>Post-17 OT</th>
                <th>OT @ base</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr id="placeholderRow">
                <td colspan="9" class="note">No entries yet — add one above.</td>
              </tr>
            </tbody>
          </table>
          <div class="btnrow">
            <button id="exportDoc" class="primary" type="button">Export to Word (.doc)</button>
            <button id="exportPdf" type="button">Export to PDF</button>
            <button id="clearLog" class="danger" type="button">Clear table</button>
          </div>
        </div>

        <p class="note" style="margin-top:12px;">
          Authorisation is captured on the exported document only.
        </p>
      </div>
    </div>

    <!-- Global debug panel -->
    <details class="debug">
      <summary>Debug panel</summary>
      <pre id="debugLog">(empty)</pre>
    </details>

    <!-- Calendar settings (Calendar ID hidden by default) -->
    <details class="calendar-settings">
      <summary>Calendar settings (Calendar ID)</summary>
      <div class="small-note" style="margin-top:4px;">
        Advanced: change which Google Calendar this tool reads from. Usually leave as-is.
      </div>
      <div style="margin-top:6px;max-width:460px;">
        <label for="calendarId">Calendar ID</label>
        <input id="calendarId"
               value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
        <div class="small-note">
          Same shared calendar you use in the other AVD tools.
        </div>
      </div>
    </details>

    <!-- API KEY PANEL (OpenAI – shared with other tools) -->
    <details class="api">
      <summary>API key (OpenAI) – hidden by default</summary>
      <div class="small-note" style="margin-top:4px;">
        Stored locally in <code>localStorage['avd_job_report_openai_key']</code>. Not sent anywhere except OpenAI’s API.
        This overtime tool doesn’t call OpenAI yet, but shares the same key as the other tools.
      </div>
      <div style="display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap;">
        <input id="apiKeyInput" type="password" placeholder="sk-..." style="flex:1 1 220px;max-width:380px;" />
        <button type="button" id="saveApiKeyBtn">Save</button>
        <button type="button" id="clearApiKeyBtn">Forget</button>
      </div>
      <div id="apiKeyStatus" class="small-note"></div>
    </details>
  </div>

  <script>
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
    let accessToken = null;
    let tokenClient = null;

    const STORAGE_KEY = "avd_ot_stable_calendar_autofetch_v4"; // keep same key for now
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";

    const GRACE_END = 9*60;      // 09:00
    const CORE_END  = 17*60;     // 17:00

    // ========= DEBUG LOGGER =========
    function logDebug(msg) {
      try {
        const el = document.getElementById("debugLog");
        if (!el) return;
        const ts = new Date().toISOString().replace("T"," ").slice(0,19);
        el.textContent += "[" + ts + "] " + msg + "\n";
        el.scrollTop = el.scrollHeight;
      } catch (e) {
        console && console.warn && console.warn("debugLog error", e);
      }
    }

    function setStatus(msg, ok) {
      const el = document.getElementById("authStatus");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.className = "note " + (ok ? "ok" : "warn");
      logDebug("AUTH: " + msg);
    }

    // ========= GOOGLE AUTH =========
    function initAuth() {
      if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
        logDebug("initAuth: Google auth library not ready yet.");
        return;
      }
      tokenClient = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: "",
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in", true);
            autoFetch();
          } else {
            setStatus("Sign-in failed", false);
          }
        }
      });
      logDebug("initAuth: tokenClient initialised.");
    }

    async function signIn() {
      logDebug("signIn: clicked.");
      if (!tokenClient) initAuth();
      if (!tokenClient) {
        setStatus("Auth library not ready. Try again.", false);
        return;
      }
      tokenClient.requestAccessToken();
    }

    function timeRangeISO(dateStr) {
      const [y,m,d] = dateStr.split("-").map(Number);
      const start = new Date(Date.UTC(y, m-1, d, 0,0,0));
      const end = new Date(Date.UTC(y, m-1, d, 23,59,59));
      return { timeMin: start.toISOString(), timeMax: end.toISOString() };
    }

    function spanISO(fromStr, toStr) {
      const { timeMin } = timeRangeISO(fromStr);
      const { timeMax } = timeRangeISO(toStr);
      return { timeMin, timeMax };
    }

    async function fetchEvents() {
      logDebug("fetchEvents: start.");
      if (!accessToken) { setStatus("Sign in first", false); return; }

      const calId = (document.getElementById("calendarId").value || "primary").trim();

      const fromStr = document.getElementById("fromDate").value.trim();
      const toStr = document.getElementById("toDate").value.trim();
      if (!fromStr || !toStr) {
        setStatus("No date range set", false);
        return;
      }

      const { timeMin, timeMax } = spanISO(fromStr, toStr);

      const url = new URL(
        "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(calId) +
        "/events"
      );
      url.searchParams.set("singleEvents", "true");
      url.searchParams.set("orderBy", "startTime");
      url.searchParams.set("timeMin", timeMin);
      url.searchParams.set("timeMax", timeMax);
      url.searchParams.set("maxResults", "2500");

      logDebug("fetchEvents: " + url.toString());

      const res = await fetch(url, { headers: { Authorization: "Bearer " + accessToken } });
      if (!res.ok) { setStatus("API error " + res.status, false); return; }
      const data = await res.json();

      const sel = document.getElementById("eventPick");
      sel.innerHTML = '<option value="">— Select recent event (optional) —</option>';

      // Sort events so most recent start time is first
      const items = (data.items || []).slice().sort((a, b) => {
        const aStart = a.start ? (a.start.dateTime || a.start.date) : null;
        const bStart = b.start ? (b.start.dateTime || b.start.date) : null;
        if (!aStart && !bStart) return 0;
        if (!aStart) return 1;
        if (!bStart) return -1;
        return new Date(bStart) - new Date(aStart);
      });

      items.forEach(ev => {
        const title = ev.summary || "(no title)";
        let dateStr = "";
        if (ev.start) {
          if (ev.start.date) dateStr = ev.start.date;
          else if (ev.start.dateTime) dateStr = ev.start.dateTime.slice(0,10);
        }
        const opt = document.createElement("option");
        opt.value = title;
        opt.textContent = title + (dateStr ? "  —  " + dateStr : "");
        if (dateStr) opt.dataset.date = dateStr;
        sel.appendChild(opt);
      });
      setStatus("Loaded " + items.length + " events", true);
      logDebug("fetchEvents: loaded " + items.length + " events.");
    }

    function autoFetch() {
      logDebug("autoFetch: attempting to fetch events after sign-in.");
      fetchEvents().catch(err => {
        logDebug("autoFetch error: " + (err && err.message ? err.message : String(err)));
      });
    }

    // ========= STATE PERSISTENCE =========
    function serializeLog() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      return rows.map(r => ({
        date: r.children[1].textContent.trim(),
        returnTime: r.children[2].textContent.trim(),
        job: r.children[3].textContent.trim(),
        total: r.children[4].textContent.trim(),
        pre9: r.children[5].textContent.trim(),
        core: r.children[6].textContent.trim(),
        post17: r.children[7].textContent.trim(),
        otBase: r.children[8].textContent.trim()
      }));
    }

    function saveState() {
      const data = {
        log: serializeLog(),
        baseRate: document.getElementById("baseRate").value || "",
        calendarId: document.getElementById("calendarId").value || "",
        fromDate: document.getElementById("fromDate").value || "",
        toDate: document.getElementById("toDate").value || ""
      };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
      catch(e) { logDebug("saveState error: " + e.message); }
    }

    function restoreLog(items) {
      const tbody = document.getElementById("logBody");
      tbody.innerHTML = "";
      if (!items || !items.length) { addPlaceholder(); updateLogCount(); return; }
      items.forEach(addRowFromData);
      updateLogCount();
    }

    function loadState() {
      let raw = null;
      try { raw = localStorage.getItem(STORAGE_KEY); }
      catch(e) { logDebug("loadState error: " + e.message); }
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data.baseRate) document.getElementById("baseRate").value = data.baseRate;
        if (data.calendarId) document.getElementById("calendarId").value = data.calendarId;
        if (data.fromDate) document.getElementById("fromDate").value = data.fromDate;
        if (data.toDate) document.getElementById("toDate").value = data.toDate;
        if (Array.isArray(data.log)) restoreLog(data.log);
      } catch(e) {
        logDebug("loadState parse error: " + e.message);
      }
    }

    function ensureDefaults() {
      const now = new Date();
      const fmt = d => d.toISOString().slice(0,10);
      if (!document.getElementById("date").value) document.getElementById("date").value = fmt(now);

      const leave = document.getElementById("leaveTime");
      if (!leave.value) {
        leave.value = "07:45";
      }

      const rt = document.getElementById("returnTime");
      if (!rt.value) {
        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(Math.round(now.getMinutes()/5)*5).padStart(2,"0");
        rt.value = hh + ":" + mm;
      }

      // Default to last 7 days including today
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
      const start = new Date(end);
      start.setDate(start.getDate() - 6); // 7 days window including today
      start.setHours(0,0,0,0);

      if (!document.getElementById("fromDate").value) document.getElementById("fromDate").value = fmt(start);
      if (!document.getElementById("toDate").value) document.getElementById("toDate").value = fmt(end);

      const calEl = document.getElementById("calendarId");
      if (!calEl.value) {
        calEl.value = "bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com";
      }
    }

    // ========= CALCULATION =========
    function minutesFromHHMM(v) {
      if (!v) return null;
      const parts = v.split(":");
      if (parts.length !== 2) return null;
      const hh = Number(parts[0]);
      const mm = Number(parts[1]);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
      return hh*60 + mm;
    }

    function fmtHours(mins) {
      if (mins == null || isNaN(mins)) return "—";
      const h = Math.floor(mins/60);
      const m = Math.round(mins%60);
      return h + "h " + String(m).padStart(2,"0") + "m";
    }

    function fmtMoney(pounds) {
      if (pounds == null || isNaN(pounds)) return "—";
      return "£" + pounds.toFixed(2);
    }

    function updateDayTypeLabel(fullOfficeDay, officeFinishDay) {
      const el = document.getElementById("dayTypeLabel");
      if (!el) return;
      let text = "Day type: ";
      if (fullOfficeDay) {
        text += "Full office/admin day";
      } else if (officeFinishDay) {
        text += "Office-finish day";
      } else {
        text += "Field day";
      }
      el.textContent = text;
    }

    function calc() {
      logDebug("calc: running.");
      const pick = document.getElementById("eventPick");
      if (pick && pick.value) {
        const opt = pick.selectedOptions && pick.selectedOptions[0];
        if (opt) {
          document.getElementById("jobRef").value = opt.textContent.trim();
          if (opt.dataset.date) document.getElementById("date").value = opt.dataset.date;
        }
      }

      const leaveVal = document.getElementById("leaveTime").value || "07:45";
      let leaveMin = minutesFromHHMM(leaveVal);
      if (leaveMin == null) {
        alert("Enter a valid leave time (HH:MM).");
        return;
      }

      const rtVal = document.getElementById("returnTime").value;
      const baseRate = parseFloat(
        (document.getElementById("baseRate").value || "15.70").replace(",",".")
      );
      let endMin = minutesFromHHMM(rtVal);
      if (endMin == null) { alert("Select a valid return time."); return; }

      // handle cross-midnight
      if (endMin < leaveMin) endMin += 24*60;

      const fullOfficeDay = document.getElementById("fullOfficeDay").checked;
      const officeFinishDay = !fullOfficeDay && document.getElementById("officeFinishDay").checked;

      // Effective end-of-work for overtime purposes:
      // - office-finish day: cap at 17:00
      // - otherwise: actual return time
      let effectiveEnd = endMin;
      if (officeFinishDay) {
        effectiveEnd = Math.min(endMin, CORE_END);
      }

      // Basic spans using effective end
      const totalWorked = Math.max(0, effectiveEnd - leaveMin);

      // Pre-09 span (raw)
      let pre9Span = 0;
      if (effectiveEnd > leaveMin && leaveMin < GRACE_END) {
        pre9Span = Math.max(0, Math.min(effectiveEnd, GRACE_END) - leaveMin);
      }

      // Core 09–17 span
      let core = 0;
      if (effectiveEnd > GRACE_END) {
        const coreStart = Math.max(leaveMin, GRACE_END);
        const coreEnd = Math.min(effectiveEnd, CORE_END);
        core = Math.max(0, coreEnd - coreStart);
      }

      // Post-17 span (raw)
      let post17Span = 0;
      if (!officeFinishDay && effectiveEnd > CORE_END) {
        post17Span = Math.max(0, effectiveEnd - CORE_END);
      }

      // Apply overtime rules
      let pre9OT = pre9Span;
      let post17OT = post17Span;

      if (fullOfficeDay) {
        pre9OT = 0;
        post17OT = 0;
      } else if (officeFinishDay) {
        // Pre-9 still counts with 15min deduction, no OT after 17:00
        pre9OT = Math.max(0, pre9Span - 15);
        post17OT = 0;
      } else {
        // Normal field day: 15min compromise both sides
        if (pre9OT > 0) pre9OT = Math.max(0, pre9OT - 15);
        if (post17OT > 0) post17OT = Math.max(0, post17OT - 15);
      }

      const totalOT = pre9OT + post17OT;
      const otBase = (totalOT/60)*baseRate;

      document.getElementById("allHours").textContent = fmtHours(totalWorked);
      document.getElementById("graceHours").textContent = fmtHours(pre9OT);
      document.getElementById("coreHours").textContent = fmtHours(core);
      document.getElementById("otHours").textContent = fmtHours(post17OT);
      document.getElementById("otBase").textContent = fmtMoney(otBase);

      updateDayTypeLabel(fullOfficeDay, officeFinishDay);

      logDebug(
        "calc spans: leave=" + leaveMin +
        " total=" + totalWorked +
        " pre9Span=" + pre9Span + " pre9OT=" + pre9OT +
        " core=" + core +
        " post17Span=" + post17Span + " post17OT=" + post17OT +
        " fullOfficeDay=" + fullOfficeDay +
        " officeFinishDay=" + officeFinishDay
      );
    }

    // ========= LOG HANDLING =========
    function updateLogCount() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      const badge = document.getElementById("logCount");
      const n = rows.length;
      badge.textContent = n === 1 ? "1 entry" : n + " entries";
    }

    function mkBtn(label, className) {
      const b = document.createElement("button");
      b.type = "button";
      b.className = className || "";
      b.textContent = label;
      b.style.border = "1px solid var(--border)";
      b.style.borderRadius = "8px";
      b.style.padding = "6px 10px";
      return b;
    }

    function addPlaceholder() {
      const tbody = document.getElementById("logBody");
      const tr = document.createElement("tr");
      tr.id = "placeholderRow";
      const td = document.createElement("td");
      td.colSpan = 9;
      td.className = "note";
      td.textContent = "No entries yet — add one above.";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    function addRowFromData(item) {
      const tbody = document.getElementById("logBody");
      const tr = document.createElement("tr");

      const tdAct = document.createElement("td");
      const del = mkBtn("Delete", "danger");
      del.addEventListener("click", () => {
        tr.remove();
        if (!tbody.querySelector("tr")) addPlaceholder();
        updateLogCount();
        saveState();
      });
      tdAct.appendChild(del);
      tr.appendChild(tdAct);

      [item.date, item.returnTime, item.job, item.total, item.pre9, item.core, item.post17, item.otBase]
        .forEach(txt => {
          const td = document.createElement("td");
          td.textContent = txt || "";
          tr.appendChild(td);
        });

      tbody.appendChild(tr);
    }

    function addRow() {
      calc();
      logDebug("addRow: adding new row from current results.");
      const tbody = document.getElementById("logBody");
      const ph = document.getElementById("placeholderRow");
      if (ph) ph.remove();

      const item = {
        date: document.getElementById("date").value || "",
        returnTime: document.getElementById("returnTime").value || "",
        job: document.getElementById("jobRef").value || "",
        total: document.getElementById("allHours").textContent || "",
        pre9: document.getElementById("graceHours").textContent || "",
        core: document.getElementById("coreHours").textContent || "",
        post17: document.getElementById("otHours").textContent || "",
        otBase: document.getElementById("otBase").textContent || ""
      };

      addRowFromData(item);
      updateLogCount();
      saveState();
      document.getElementById("logHeader").scrollIntoView({ behavior:"smooth", block:"start" });
    }

    function clearLog() {
      if (!confirm("Clear all log entries?")) return;
      logDebug("clearLog: clearing table.");
      const tbody = document.getElementById("logBody");
      tbody.innerHTML = "";
      addPlaceholder();
      updateLogCount();
      saveState();
    }

    // ========= EXPORT HELPERS =========
    function parseHM(s) {
      if (!s) return 0;
      const m = s.match(/(\d+)h\s*(\d+)m/i);
      if (!m) return 0;
      return parseInt(m[1],10)*60 + parseInt(m[2],10);
    }

    function fmtHM(mins) {
      const h = Math.floor(mins/60);
      const m = Math.round(mins%60);
      return h + "h " + String(m).padStart(2,"0") + "m";
    }

    function parseMoney(s) {
      if (!s) return 0;
      const v = s.replace(/[^0-9.\-]/g,"");
      return parseFloat(v || "0");
    }

    function buildDocHtmlFromLog() {
      const colWidths = ["12%","10%","34%","11%","8%","8%","9%","8%"];
      const headCells = ["Date","Return time","Job / Location","Total worked","Pre-09 OT","Core","Post-17 OT","OT @ base"];

      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      let totTotal=0, totPre9=0, totCore=0, totPost17=0, totMoney=0;

      const bodyRowsHtml = rows.map(r => {
        const date = r.children[1].textContent.trim();
        const rt   = r.children[2].textContent.trim();
        const job  = r.children[3].textContent.trim();
        const total= r.children[4].textContent.trim();
        const pre9 = r.children[5].textContent.trim();
        const core = r.children[6].textContent.trim();
        const post = r.children[7].textContent.trim();
        const base = r.children[8].textContent.trim();

        totTotal += parseHM(total);
        totPre9  += parseHM(pre9);
        totCore  += parseHM(core);
        totPost17+= parseHM(post);
        totMoney += parseMoney(base);

        return "<tr>" +
          "<td>" + date + "</td>" +
          "<td>" + rt + "</td>" +
          "<td>" + job + "</td>" +
          "<td class=\"tc\">" + total + "</td>" +
          "<td class=\"tc\">" + pre9 + "</td>" +
          "<td class=\"tc\">" + core + "</td>" +
          "<td class=\"tc\">" + post + "</td>" +
          "<td class=\"tr\">" + base + "</td>" +
        "</tr>";
      }).join("");

      const totalsRow = rows.length
        ? "<tr class=\"totals\">" +
            "<td></td>" +
            "<td></td>" +
            "<td><b>Totals</b></td>" +
            "<td class=\"tc\"><b>" + fmtHM(totTotal) + "</b></td>" +
            "<td class=\"tc\"><b>" + fmtHM(totPre9) + "</b></td>" +
            "<td class=\"tc\"><b>" + fmtHM(totCore) + "</b></td>" +
            "<td class=\"tc\"><b>" + fmtHM(totPost17) + "</b></td>" +
            "<td class=\"tr\"><b>£" + totMoney.toFixed(2) + "</b></td>" +
          "</tr>"
        : "";

      const dates = rows.map(r => r.children[1].textContent.trim()).filter(Boolean).sort();
      const title = dates.length
        ? "Overtime Logs between " + dates[0] + " and " + dates[dates.length-1]
        : "Overtime Logs";

      const css = "<style>" +
        "@page { size: A4 landscape; margin: 1.6cm; }" +
        "body { font-family: Calibri, Arial, sans-serif; font-size: 12pt; color: #000; }" +
        "h1 { font-size: 18pt; margin: 0 0 8pt 0; }" +
        "table { border-collapse: collapse; width: 100%; }" +
        "th, td { border: 1px solid #cccccc; padding: 6pt; vertical-align: top; }" +
        "th { background: #efefef; font-weight: bold; }" +
        ".tc { text-align: center; }" +
        ".tr { text-align: right; }" +
        ".totals td { background: #f7f7f7; }" +
        ".explain { margin: 0 0 10pt 0; }" +
        ".auth { margin-top: 14pt; }" +
      "</style>";

      const colgroup = "<colgroup>" + colWidths.map(w => "<col style=\"width:" + w + "\">").join("") + "</colgroup>";
      const thead = "<thead><tr>" + headCells.map(h => "<th>" + h + "</th>").join("") + "</tr></thead>";
      const tbody = "<tbody>" +
        (bodyRowsHtml || "<tr><td colspan=\"8\">No entries</td></tr>") +
        totalsRow +
      "</tbody>";

      const explain = "<div class=\"explain\">" +
        "<p><b>How the calculations work</b></p>" +
        "<ul style=\"margin:0 0 6pt 18pt;padding:0\">" +
          "<li>Leave time defaults to 07:45 but can be adjusted for each day.</li>" +
          "<li>Time before 09:00 and after 17:00 counts as overtime, based on your recorded leave and return times.</li>" +
          "<li>On field days, 15 minutes is deducted from pre-09:00 overtime and 15 minutes from post-17:00 overtime.</li>" +
          "<li>On office-finish days, pre-09:00 overtime (after a 15 minute deduction) is kept, but there is no overtime after 17:00.</li>" +
          "<li>Full office/admin days can be flagged so that no overtime is counted.</li>" +
          "<li>Core paid hours are 09:00–17:00.</li>" +
          "<li>Overtime is shown at the base rate (e.g. £15.70/hr).</li>" +
        "</ul>" +
      "</div>";

      const auth = "<div class=\"auth\">" +
        "<h2>Authorisation</h2>" +
        "<p><b>Authorised by:</b> _____________________<br>" +
        "<b>Date:</b> _____________________</p>" +
      "</div>";

      return "<!doctype html>" +
        "<html>" +
          "<head><meta charset=\"utf-8\"><title>" + title + "</title>" + css + "</head>" +
          "<body>" +
            "<h1>" + title + "</h1>" +
            explain +
            "<table>" +
              colgroup +
              thead +
              tbody +
            "</table>" +
            auth +
          "</body>" +
        "</html>";
    }

    function exportWord() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      if (!rows.length) { alert("No rows to export. Add rows first."); return; }
      const html = buildDocHtmlFromLog();
      const titleMatch = html.match(/<title>(.*?)<\/title>/i);
      const fname = (titleMatch ? titleMatch[1] : "overtime_logs").replace(/\s+/g,"_").toLowerCase() + ".doc";
      const blob = new Blob([html], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function exportPdf() {
      const rows = Array.from(document.querySelectorAll("#logBody tr")).filter(r => !r.id);
      if (!rows.length) { alert("No rows to export. Add rows first."); return; }
      const html = buildDocHtmlFromLog();
      const w = window.open("", "_blank");
      if (!w) { alert("Pop-up blocked. Allow pop-ups for this site to export PDF."); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.onload = () => { setTimeout(() => { w.print(); }, 250); };
    }

    // ========= API KEY PANEL LOGIC =========
    function refreshApiKeyStatus() {
      const statusEl = document.getElementById("apiKeyStatus");
      const key = localStorage.getItem(OPENAI_KEY_STORAGE);
      if (key) {
        statusEl.textContent = "API key is stored in this browser.";
      } else {
        statusEl.textContent = "No API key stored yet.";
      }
    }

    function handleSaveApiKey() {
      const input = document.getElementById("apiKeyInput");
      const v = (input.value || "").trim();
      if (!v) {
        alert("Enter a key first.");
        return;
      }
      localStorage.setItem(OPENAI_KEY_STORAGE, v);
      input.value = "";
      refreshApiKeyStatus();
      logDebug("OpenAI key saved to localStorage.");
    }

    function handleClearApiKey() {
      localStorage.removeItem(OPENAI_KEY_STORAGE);
      refreshApiKeyStatus();
      logDebug("OpenAI key cleared from localStorage.");
    }

    // ========= INIT =========
    window.addEventListener("DOMContentLoaded", () => {
      logDebug("DOMContentLoaded.");
      ensureDefaults();
      loadState();

      window.addEventListener("load", () => {
        logDebug("window.load: trying initAuth + auto token request.");
        try {
          initAuth();
          if (tokenClient) {
            tokenClient.requestAccessToken();
            logDebug("window.load: requested access token automatically.");
          }
        } catch(e) {
          logDebug("window.load initAuth error: " + e.message);
        }
      });

      document.getElementById("signin").addEventListener("click", signIn);
      document.getElementById("fetchEvents").addEventListener("click", () => {
        fetchEvents().catch(err => logDebug("fetchEvents click error: " + (err && err.message ? err.message : String(err))));
      });
      document.getElementById("useSel").addEventListener("click", () => {
        const pick = document.getElementById("eventPick");
        const jobRef = document.getElementById("jobRef");
        const dateEl = document.getElementById("date");
        if (pick.value) {
          jobRef.value = (pick.selectedOptions[0]?.textContent || pick.value).trim();
        }
        const d = pick.selectedOptions && pick.selectedOptions[0] && pick.selectedOptions[0].dataset.date;
        if (d) dateEl.value = d;
      });
      document.getElementById("eventPick").addEventListener("change", (e) => {
        const opt = e.target.selectedOptions && e.target.selectedOptions[0];
        if (!opt) return;
        if (opt.textContent) document.getElementById("jobRef").value = opt.textContent.trim();
        if (opt.dataset.date) document.getElementById("date").value = opt.dataset.date;
      });

      document.getElementById("calcBtn").addEventListener("click", calc);
      document.getElementById("addRowBtn").addEventListener("click", addRow);
      document.getElementById("clearLog").addEventListener("click", clearLog);
      document.getElementById("exportDoc").addEventListener("click", exportWord);
      document.getElementById("exportPdf").addEventListener("click", exportPdf);

      ["baseRate","calendarId","fromDate","toDate"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", saveState);
        el.addEventListener("input", saveState);
      });

      // API key panel
      const saveKeyBtn = document.getElementById("saveApiKeyBtn");
      const clearKeyBtn = document.getElementById("clearApiKeyBtn");
      if (saveKeyBtn && clearKeyBtn) {
        saveKeyBtn.addEventListener("click", handleSaveApiKey);
        clearKeyBtn.addEventListener("click", handleClearApiKey);
        refreshApiKeyStatus();
      }

      updateLogCount();
      updateDayTypeLabel(false, false);
    });
  </script>
</body>
</html>